#!/bin/bash

# Ignore the README, and anything named exactly .git
IGNORE_RE="^\./README$|/\.git(/|$)"

# Set OCDDIR in $HOME/.bashrc_$(dnsdomainname) for your local setup.

: ${OCDDIR:="$HOME/.ocd"}

archive_dir=`mktemp -d`
mkdir $archive_dir/backup

archive() {
  mkdir -p `dirname $archive_dir/backup/$1`
  cp -Lp $1 $archive_dir/backup/$1
  rm $1
}

echo -n "$OCDDIR: "
if [ ! -d "$OCDDIR" ]; then
  echo "doesn't exist!" && continue
fi
cd $OCDDIR/files

files=$(find . -type f | egrep -v  "$IGNORE_RE")
dirs=$(find . -type d | egrep -v  "$IGNORE_RE")

for dir in $dirs; do
  if [ ! -d $HOME/$dir ]; then
    archive $HOME/$dir
  fi
  mkdir -p $HOME/$dir
done

for file in $files; do
  echo -n .
  src="$file"
  dst="$HOME/$file"
  if [ -f $dst -o -h $dst ]; then
    archive $dst
    rm -f $dst
  fi
  cp -p $file $dst
  done
echo

tar -czf $OCDDIR/backup.tar.gz -C $archive_dir backup/
#rm -rf $archive_dir
